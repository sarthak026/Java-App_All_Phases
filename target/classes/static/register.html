<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:;">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Register - SarApp Multi-Tenant</title>
    <link href="https://fonts.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        /* ---------------------------------- */
        /* 1. Root Variables (Matching Login Page) */
        /* ---------------------------------- */
        :root {
            --primary-color: #1e3a8a; /* Deep Navy Blue */
            --primary-color-dark: #1e40af;
            --primary-light: #eff6ff;
            --text-dark: #1f2937;
            --text-medium: #6b7280;
            --bg-page: #f9fafb;
            --bg-card: white;
            --border-color: #e5e7eb;
            --shadow-subtle: 0 8px 30px rgba(0, 0, 0, 0.12);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* ---------------------------------- */
        /* 2. Full-Page Split Screen Layout FIX */
        /* ---------------------------------- */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0; /* Remove padding from body for full look */
        }

        .split-register-container {
            display: flex;
            width: 95%; /* Increased width */
            max-width: 1200px; /* Increased max width */
            height: 95vh; /* **FIX: Utilize almost full vertical height** */
            max-height: 950px;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--shadow-subtle);
            animation: cardPopIn 0.8s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        @keyframes cardPopIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Left Pane (Branding) */
        .left-pane {
            flex: 1;
            min-width: 300px;
            background: var(--primary-color);
            padding: 40px;
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .left-pane .logo-icon {
            font-size: 80px;
            margin-bottom: 20px;
            opacity: 0.15;
            color: white;
        }

        .left-pane h2 {
            font-size: 36px;
            font-weight: 900;
            margin-bottom: 15px;
            z-index: 1;
        }

        /* Right Pane (Form - Replaces original .register-container) */
        .register-container {
            background: var(--bg-card);
            flex: 1;
            /* FIX: Increased padding and made it scrollable for long forms */
            padding: 60px 80px;
            width: auto;
            max-width: none;
            box-shadow: none;
            border-top: none;
            animation: none;
            /* FIX: Allow scrolling if content is too tall */
            overflow-y: auto;
        }

        /* ---------------------------------- */
        /* 3. Elements Styling & Messages */
        /* ---------------------------------- */
        .logo { margin-bottom: 25px; } /* Kept for title structure */

        .logo h1 {
            color: var(--text-dark);
            font-size: 28px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: flex-start; /* Align left in the form pane */
        }

        .logo h1 i {
            color: var(--primary-color);
            margin-right: 10px;
        }

        /* Tenant Info (Updated Look) */
        .subdomain-info {
            background: var(--primary-light);
            padding: 10px 12px;
            border-radius: 8px;
            margin-bottom: 25px;
            text-align: center;
            color: var(--primary-color);
            font-weight: 700;
            font-size: 14px;
            border: 1px solid rgba(30, 58, 138, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .form-group { margin-bottom: 20px; }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-dark);
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 14px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 16px;
            background: var(--bg-page);
            color: var(--text-dark);
            transition: all 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.15);
            background: white;
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 4px 10px rgba(30, 58, 138, 0.4);
            margin-top: 15px; /* Add space above button */
        }

        .btn-primary:hover {
            background-color: var(--primary-color-dark);
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(30, 58, 138, 0.6);
        }

        .login-link {
            text-align: center;
            margin-top: 25px;
            color: var(--text-medium);
            font-size: 14px;
        }

        .login-link a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
        }

        .login-link a:hover {
            text-decoration: underline;
        }

        /* Message Boxes (Fixed Styles) */
        .error-message, .success-message {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            font-weight: 600;
            font-size: 14px;
            align-items: center;
            gap: 10px;
        }

        .error-message {
            background: #fef2f2;
            color: #ef4444;
            border: 1px solid #fecaca;
        }
        .success-message {
            background: #f0fdf4;
            color: #10b981;
            border: 1px solid #d1fae5;
        }

        .password-requirements {
            font-size: 12px;
            color: var(--text-medium);
            margin-top: 5px;
            padding-left: 5px;
            line-height: 1.5;
        }

        .password-requirements ul {
            margin-top: 5px;
            padding-left: 20px;
            list-style-type: 'â€” '; /* Changed bullet style for cleaner look */
        }

        /* Responsive fallback for smaller screens */
        @media (max-width: 800px) {
            body { padding: 20px; }
            .split-register-container {
                flex-direction: column;
                height: auto;
                max-width: 420px;
                width: 100%;
            }
            .left-pane {
                min-height: 200px;
                padding: 30px;
            }
            .register-container {
                padding: 30px 20px;
            }
        }
    </style>
</head>
<body>
<div class="split-register-container">

    <div class="left-pane">
        <i class="fas fa-cubes logo-icon"></i>
        <h2>SarApp</h2>
        <p>Secure access portal for multi-tenant identity and single sign-on management.</p>
    </div>

    <div class="register-container">

        <div class="logo">
            <h1 id="mainTitle"><i class="fas fa-user-plus"></i> Register</h1>
        </div>

        <div class="subdomain-info" id="subdomainInfo">
            <i class="fas fa-building"></i> Loading tenant...
        </div>

        <div class="error-message" id="errorMessage"><i class="fas fa-exclamation-circle"></i></div>
        <div class="success-message" id="successMessage"><i class="fas fa-check-circle"></i></div>

        <form id="registerForm">
            <div class="form-group">
                <label for="firstName">First Name</label>
                <input type="text" id="firstName" name="firstName" required placeholder="Your first name">
            </div>

            <div class="form-group">
                <label for="lastName">Last Name</label>
                <input type="text" id="lastName" name="lastName" required placeholder="Your last name">
            </div>

            <div class="form-group">
                <label for="email">Email Address</label>
                <input type="email" id="email" name="email" required placeholder="name@company.com">
            </div>

            <div class="form-group" id="tenantSubdomainGroup" style="display: none;">
                <label for="tenantSubdomain">Organization Subdomain</label>
                <input type="text" id="tenantSubdomain" name="tenantSubdomain" placeholder="Enter your unique organization name">
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" name="password" required placeholder="Create a strong password">
                <div class="password-requirements">

                </div>
            </div>

            <div class="form-group">
                <label for="confirmPassword">Confirm Password</label>
                <input type="password" id="confirmPassword" name="confirmPassword" required placeholder="Re-enter password">
            </div>

            <button type="submit" class="btn btn-primary">
                <i class="fas fa-user-plus"></i> Create Account
            </button>
        </form>

        <div class="login-link">
            Already have an account? <a href="login.html">Sign In</a>
        </div>
    </div>
</div>

<script>
    // --- Dynamic Configuration (ORIGINAL LOGIC PRESERVED) ---
    const hostname = window.location.hostname;
    const currentSubdomain = hostname.split('.')[0];
    const isSuperAdminDomain = currentSubdomain === 'superadmin';

    // --- DOM Elements ---
    const subdomainInfo = document.getElementById('subdomainInfo');
    const tenantSubdomainGroup = document.getElementById('tenantSubdomainGroup');
    const tenantSubdomainInput = document.getElementById('tenantSubdomain');
    const mainTitle = document.getElementById('mainTitle');

    // --- Setup UI based on Domain (ORIGINAL LOGIC PRESERVED) ---
    if (isSuperAdminDomain) {
        // Customer Admin Self-Registration Flow
        subdomainInfo.innerHTML = '<i class="fas fa-building"></i> New Customer Organization.';
        mainTitle.innerHTML = '<i class="fas fa-user-plus"></i> Register Organization Admin';
        tenantSubdomainGroup.style.display = 'block';
        tenantSubdomainInput.required = true;
    } else {
        // End User Registration Flow
        subdomainInfo.innerHTML = `<i class="fas fa-building"></i> Registering for tenant: ${currentSubdomain.toUpperCase()}`;
        mainTitle.innerHTML = '<i class="fas fa-user-plus"></i> Register End User';
        tenantSubdomainInput.required = false;
    }

    // --- Registration Handler (ORIGINAL LOGIC PRESERVED) ---
    document.getElementById('registerForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        hideMessages();

        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        if (password !== confirmPassword) {
            showError('Passwords do not match!');
            return;
        }

        if (!validatePassword(password)) {
            showError('Password does not meet requirements!');
            return;
        }

        const submitBtn = document.querySelector('.btn-primary');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Registering...'; // Added spinner

        const requestBody = {
            firstName: document.getElementById('firstName').value,
            lastName: document.getElementById('lastName').value,
            email: document.getElementById('email').value,
            password: password,
            ...(isSuperAdminDomain && { tenantSubdomain: tenantSubdomainInput.value })
        };

        try {
            // Use the single public registration endpoint
            const response = await fetch('/api/auth/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });

            const data = await response.text();

            if (response.ok) {
                showSuccess('Registration successful! Redirecting to login...');
                document.getElementById('registerForm').reset();
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
            } else {
                let errorMsg = 'Registration failed. Please try again.';
                try {
                    const errorData = JSON.parse(data);
                    errorMsg = errorData.error || errorData.message || errorMsg;
                } catch (e) {
                    // Non-JSON error handling
                }
                showError(errorMsg);
            }
        } catch (error) {
            showError('Network error. Please try again.');
            console.error('Registration error:', error);
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-user-plus"></i> Create Account';
        }
    });

    // --- Utility Functions (Error/Success/Validation - UPDATED FOR ICONS) ---
    function validatePassword(password) {
        if (password.length < 8) return false;
        if (!/[A-Z]/.test(password)) return false;
        if (!/[a-z]/.test(password)) return false;
        if (!/[0-9]/.test(password)) return false;
        if (!/[!@#$%^&*(),.?":{}|<>]/.test(password)) return false;
        return true;
    }

    function showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> <span>${message}</span>`;
        errorDiv.style.display = 'flex';
        document.getElementById('successMessage').style.display = 'none';
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function showSuccess(message) {
        const successDiv = document.getElementById('successMessage');
        successDiv.innerHTML = `<i class="fas fa-check-circle"></i> <span>${message}</span>`;
        successDiv.style.display = 'flex';
        document.getElementById('errorMessage').style.display = 'none';
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function hideMessages() {
        document.getElementById('errorMessage').style.display = 'none';
        document.getElementById('successMessage').style.display = 'none';
    }
</script>
</body>
</html>